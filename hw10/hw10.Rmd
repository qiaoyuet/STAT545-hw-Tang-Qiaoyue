---
title: "hw10"
author: "Qiaoyue Tang"
date: "November 29, 2017"
output: github_document
---

```{r include=FALSE}
library(tidyverse)
library(magrittr)
library(purrr)
library(glue)
library(stringr)
library(rvest)
library(xml2)
library(ggplot2)
library(httr)
```

## Scrape data

```{r}
my_url <- "https://www.billboard.com/charts/greatest-billboard-200-albums#"
page_title <- read_html(my_url)

get_album <- function(my_link) {
  my_link %>% 
    read_html() %>% 
    html_nodes(css = ".chart-row__song") %>% 
    html_text() %>% 
    return()
}

get_artist <- function(my_link) {
  my_link %>% 
    read_html() %>% 
    html_nodes(css = ".chart-row__artist") %>% 
    html_text() %>%
    str_trim(side = "both") %>% 
    return()
}

get_rank <- function(my_link) {
  my_link %>% 
    read_html() %>% 
    html_nodes(css = ".chart-row__current-week") %>% 
    html_text() %>% 
    return()
}

Album <- get_album(my_url)
Artist <- get_artist(my_url)
Rank <- get_rank(my_url)

df <- data_frame(Rank = Rank,
                 Album = Album,
                 Artist = Artist,
                 Link = glue("https://www.billboard.com/music/{Artist}") %>% 
                   str_to_lower() %>% 
                   str_replace_all(" ","-") %>% 
                   str_replace_all("&","") %>% 
                   str_replace_all("'","") %>% 
                   str_replace_all("--","-") %>% 
                   str_replace_all(",","") %>% 
                   str_replace_all("!",""))

df$Link[24] <- "https://www.billboard.com/music/mc-hammer"


get_stats <- function(link) {
  link %>% 
    read_html() %>% 
    html_nodes(css = ".artist-section--chart-history__stats__stat--number") %>% 
    html_text() %>% 
    return()
}

get_stats_safe <- purrr::possibly(get_stats, "None available")

df <- df %>% 
  mutate(Stats = map(Link, get_stats_safe))

No_1_hits <- c()
for (i in 1:200) {
  No_1_hits[i] <- df$Stats[[i]][1]
}
No_1_hits

Top_10_hits <- c()
for(i in 1:200) {
  Top_10_hits[i] <- df$Stats[[i]][2]
}
Top_10_hits

Songs <- c()
for(i in 1:200) {
  Songs[i] <- df$Stats[[i]][3]
}
Songs

df_clean <- data_frame(Rank = Rank,
                 Album = Album,
                 Artist = Artist,
                 Link = glue("https://www.billboard.com/music/{Artist}") %>% 
                   str_to_lower() %>% 
                   str_replace_all(" ","-") %>% 
                   str_replace_all("&","") %>% 
                   str_replace_all("'","") %>% 
                   str_replace_all("--","-") %>% 
                   str_replace_all(",","") %>% 
                   str_replace_all("!",""),
                 No_1_hits = as.numeric(No_1_hits),
                 Top_10_hits = as.numeric(Top_10_hits),
                 Songs = as.numeric(Songs))
```

## Analysis on clean dataframe

```{r}
which.max(df_clean$No_1_hits)

hist(df_clean$No_1_hits)
```


